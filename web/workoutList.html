<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Workout List</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body class="bg-light">
<div class="container py-3">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h1 class="h4 mb-0">I tuoi workout</h1>
    <button id="btn-logout" class="btn btn-outline-secondary btn-sm">Logout</button>
  </div>

  <button id="btn-new-today" class="btn btn-success btn-lg w-100 mb-3">
    Nuovo workout oggi
  </button>

  <div class="card">
    <div class="card-body">
      <h2 class="h5 mb-3">Storico</h2>
      <div class="table-responsive">
        <table class="table table-sm" id="tbl-dates">
          <thead><tr><th>Data</th><th class="text-end">Azioni</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
      <div id="msg-list" class="mt-2 d-none"></div>
    </div>
  </div>
</div>

<script>
function todayYMD() {
  const d = new Date();
  const m = String(d.getMonth() + 1).padStart(2, '0');
  const day = String(d.getDate()).padStart(2, '0');
  return d.getFullYear() + '-' + m + '-' + day;
}

function ensureLogin(cb) {
  $.getJSON('auth.php?action=me').done(function(res) {
    if (!res.logged) {
      window.location = 'login.html';
    } else {
      cb(res);
    }
  });
}

function loadDates() {
  $('#tbl-dates tbody').empty();
  $('#msg-list').addClass('d-none');

  $.getJSON('api.php?action=listWorkoutDates')
    .done(function(res) {
      var dates = res.dates || [];
      if (dates.length === 0) {
        $('#msg-list')
          .removeClass('d-none alert-danger')
          .addClass('alert alert-info')
          .text('Nessun workout registrato.');
        return;
      }

      const today = todayYMD();

      dates.forEach(function(d) {
        var tr = $('<tr>');
        tr.append($('<td>').text(d));

        var btn = $('<button>')
          .addClass('btn btn-sm btn-primary')
          .text('Apri')
          .on('click', function() {
            if (d === today) {
              // Oggi: vai in modalit√† edit direttamente su currentworkout
              var ref = d.replace(/-/g, '');
              window.location = 'currentworkout.html?workoutRef=' + encodeURIComponent(ref);
            } else {
              // Giorni passati: sola visualizzazione
              window.location = 'workoutView.html?date=' + encodeURIComponent(d);
            }
          });

        tr.append($('<td class="text-end">').append(btn));
        $('#tbl-dates tbody').append(tr);
      });
    });
}

$(function() {
  ensureLogin(function() {
    loadDates();
  });

  $('#btn-new-today').on('click', function() {
    window.location = 'currentworkout.html';
  });

  $('#btn-logout').on('click', function() {
    $.getJSON('auth.php?action=logout', function() {
      window.location = 'login.html';
    });
  });
});
</script>
</body>
</html>
