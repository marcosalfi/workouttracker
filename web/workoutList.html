<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Workout List</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
</head>
<body class="bg-light">
<div class="container py-3">
<div class="d-flex justify-content-between align-items-center mb-3">
  <h1 class="h4 mb-0">I tuoi workout</h1>

  <div class="d-flex gap-3">

    <!-- Logout -->
    <button id="btn-logout" class="btn btn-sm btn-outline-danger" title="Logout">
      <i class="bi bi-box-arrow-right"></i>
    </button>
  </div>
</div>

  <button id="btn-new-today" class="btn btn-success btn-lg w-100 mb-3">
    Nuovo workout oggi
  </button>

  <div class="card">
    <div class="card-body">
      <h2 class="h5 mb-3">Storico</h2>
      <div class="table-responsive">
        <table class="table table-sm" id="tbl-dates">
          <thead>
          <tr>
            <th style="width: 4rem;">#</th>
            <th>Data</th>
            <th>Titolo</th>
            <th class="text-end">Azioni</th>
          </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div id="msg-list" class="mt-2 d-none"></div>
    </div>
  </div>
</div>

<script>

function todayYMD() {
  const d = new Date();
  const m = String(d.getMonth() + 1).padStart(2, '0');
  const day = String(d.getDate()).padStart(2, '0');
  return d.getFullYear() + '-' + m + '-' + day;
}

function ensureLogin(cb) {
  $.getJSON('auth.php?action=me').done(function(res) {
    if (!res.logged) {
      const v  = Date.now(); // timestamp Unix (ms)
      window.location = 'index.html'; 
    } else {
      cb(res);
    }
  });
}

// Giorni settimana in italiano (3 lettere)
const WEEKDAYS_IT = ['dom', 'lun', 'mar', 'mer', 'gio', 'ven', 'sab'];

// YYYY-MM-DD -> "sab 01/02/2026"
function formatDateIT(ymd) {
  const d = parseYMD(ymd);
  if (!d) return ymd;

  const wd = WEEKDAYS_IT[d.getDay()];
  const dd = String(d.getDate()).padStart(2, '0');
  const mm = String(d.getMonth() + 1).padStart(2, '0');
  const yyyy = d.getFullYear();

  return wd + ' ' + dd + '/' + mm + '/' + yyyy;
}

// YYYY-MM-DD -> Date (locale, ma ci basta per ordinare)
function parseYMD(str) {
  const parts = str.split('-');
  if (parts.length !== 3) return null;
  const y = parseInt(parts[0], 10);
  const m = parseInt(parts[1], 10) - 1;
  const d = parseInt(parts[2], 10);
  return new Date(y, m, d);
}

// ISO week key (anno-settimana) per resettare la numerazione ogni settimana
function getWeekKey(date) {
  const tmp = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
  const dayNum = tmp.getUTCDay() || 7; // 1..7 (lunedì=1)
  tmp.setUTCDate(tmp.getUTCDate() + 4 - dayNum); // giovedì della settimana
  const yearStart = new Date(Date.UTC(tmp.getUTCFullYear(), 0, 1));
  const weekNo = Math.ceil((((tmp - yearStart) / 86400000) + 1) / 7);
  return tmp.getUTCFullYear() + '-W' + String(weekNo).padStart(2, '0');
}

// Calcola indice giornaliero per settimana (1..n) per ogni data
function buildWeeklyIndexMap(dates) {
  const map = {};
  const sortedAsc = dates.slice().sort(function(a, b) {
    return a.localeCompare(b); // dal più vecchio al più recente
  });

  let currentWeekKey = null;
  let counter = 0;

  sortedAsc.forEach(function(dStr) {
    const dObj = parseYMD(dStr);
    if (!dObj) {
      map[dStr] = 0;
      return;
    }

    const wk = getWeekKey(dObj);
    if (wk !== currentWeekKey) {
      currentWeekKey = wk;
      counter = 1;
    } else {
      counter++;
    }
    map[dStr] = counter;
  });

  return map;
}

function loadDates() {
  $('#tbl-dates tbody').empty();
  $('#msg-list').addClass('d-none');

  $.getJSON('api.php?action=listWorkoutDates')
  .done(function(res) {
      let items = res.items || [];

      if (!items || items.length === 0) {
        $('#msg-list')
          .removeClass('d-none alert-danger')
          .addClass('alert alert-info')
          .text('Nessun workout registrato.');
        return;
      }

      const today = todayYMD();

      // Ordina per data DESC
      items.sort(function(a, b) {
        return b.date.localeCompare(a.date);
      });

      // Serve solo per l’indice settimanale
      const dates = items.map(it => it.date);
      const weeklyIndex = buildWeeklyIndexMap(dates);

      items.forEach(function(it) {
        const d = it.date;
        const t = it.title || '';
        const c = it.count || 0;

        const tr = $('<tr>');

        // # settimanale
        tr.append($('<td>').text(weeklyIndex[d] || ''));

        // Data formattata IT + weekday
        tr.append($('<td>').text(formatDateIT(d)));

        // Titolo + count
        tr.append(
          $('<td>').html(
            $('<div>').append(
              $('<div>').text(t),
              $('<small class="text-muted">').text(c + ' esercizi')
            )
          )
        );

        // Azioni
        const btn = $('<button>')
          .addClass('btn btn-sm btn-primary')
          .text('Apri')
          .on('click', function() {
            const v  = Date.now(); // timestamp Unix (ms)
            if (d === today) {
              const ref = d.replace(/-/g, '');
              window.location = 'currentworkout.html?workoutRef=' + encodeURIComponent(ref) + '&v=' + v;;
            } else {
              window.location = 'workoutView.html?date=' + encodeURIComponent(d) + '&v=' + v;
            }
          });

        tr.append($('<td class="text-end">').append(btn));
        $('#tbl-dates tbody').append(tr);
      });
    });

}

$(function() {
  ensureLogin(function() {
    loadDates();
  });

  $('#btn-new-today').on('click', function() {
    const v  = Date.now();
    window.location = 'currentworkout.html?v=' + v;
  });
  

  $('#btn-logout').on('click', function() {
    $.getJSON('auth.php?action=logout', function() {
      const v  = Date.now();
      window.location = 'index.html';
    });
  });
});
</script>
</body>
</html>
