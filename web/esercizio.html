<!DOCTYPE html>
<html lang="it">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Esercizio</title>

  <!-- UI libs -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

  <style>
    /* Migliora il tap su mobile per la tabella dei set precedenti */
    #tbl-prev-sets tbody tr {
      cursor: pointer;
    }
  </style>
</head>

<body class="bg-light">
  <div class="container py-3">
    <!-- Header pagina -->
    <div class="d-flex justify-content-between align-items-center mb-3">
      <div>
        <h1 class="h5 mb-0" id="title-ex">Esercizio</h1>
        <!-- richiesto: niente info "precedente / lavorazione" -->
        <small id="subtitle-date" class="text-muted"></small>
      </div>

      <div class="d-flex gap-2">
        <!-- Rinomina (modale) -->
        <button id="btn-rename-open" class="btn btn-outline-primary btn-sm" title="Rinomina esercizio">
          <i class="bi bi-pencil-square"></i>
        </button>

        <!-- Timer -->
        <button id="btn-timer" class="btn btn-warning btn-sm" title="Timer">
          <i class="bi bi-hourglass-split"></i>
        </button>

        <!-- Torna indietro -->
        <button id="btn-back" class="btn btn-outline-secondary btn-sm" title="Torna">
          <i class="bi bi-arrow-left"></i>
        </button>
      </div>
    </div>

    <!-- Card inserimento reps/peso -->
    <div class="card mb-3">
      <div class="card-body">

        <div class="row g-2 mb-2 align-items-center">
          <div class="col-12 col-md-6">
            <label class="form-label">Reps</label>
            <div class="input-group">
              <button class="btn btn-outline-secondary" type="button" id="btn-reps-minus">-</button>
              <input type="number" id="txt-reps" class="form-control text-center" min="0" step="1" value="0">
              <button class="btn btn-outline-secondary" type="button" id="btn-reps-plus">+</button>
            </div>
          </div>

          <div class="col-12 col-md-6">
            <label class="form-label">Peso</label>
            <div class="input-group">
              <button class="btn btn-outline-secondary" type="button" id="btn-weight-minus">-</button>
              <input type="number" id="txt-weight" class="form-control text-center" step="0.5" value="0">
              <button class="btn btn-outline-secondary" type="button" id="btn-weight-plus">+</button>
            </div>
          </div>
        </div>

        <button id="btn-save" class="btn btn-success btn-lg w-100 mt-2">Salva set</button>

        <!-- Lasciamo msg-ex per errori (successo -> toast) -->
        <div id="msg-ex" class="mt-2 d-none"></div>
      </div>
    </div>

    <!-- Card set attuali -->
    <div class="card mb-3">
      <div class="card-body">
        <h2 class="h6 mb-2">Set eseguiti</h2>

        <div class="table-responsive">
          <table class="table table-sm" id="tbl-sets">
            <thead>
              <tr>
                <th>#</th>
                <th>Reps</th>
                <th>Peso</th>
                <th class="text-end">Azioni</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Card set precedenti (solo lettura) -->
    <div class="card" id="card-prev" style="display:none;">
      <div class="card-body">
        <h2 class="h6 mb-2">Set precedenti</h2>

        <div class="table-responsive">
          <table class="table table-sm" id="tbl-prev-sets">
            <thead>
              <tr>
                <th>#</th>
                <th>Reps</th>
                <th>Peso</th>
                <th class="text-end">Azioni</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

        <div class="small text-muted mt-2">
          Tocca una riga per copiare reps/peso nei campi sopra.
        </div>
      </div>
    </div>
  </div>

  <!-- Toast container (successo "Set salvato") -->
  <div class="toast-container position-fixed bottom-0 end-0 p-3">
    <div id="toastSaved" class="toast text-bg-success border-0" role="status" aria-live="polite" aria-atomic="true">
      <div class="d-flex">
        <div class="toast-body">
          Set salvato ✅
        </div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"
          aria-label="Chiudi"></button>
      </div>
    </div>
  </div>

  <!-- Modal rinomina esercizio -->
  <div class="modal fade" id="modalRename" tabindex="-1" aria-labelledby="modalRenameLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="modalRenameLabel">Rinomina esercizio</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Chiudi"></button>
        </div>
        <div class="modal-body">
          <label for="txt-rename" class="form-label">Nuovo nome</label>
          <input type="text" id="txt-rename" class="form-control" placeholder="Nuovo nome esercizio">
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
          <button type="button" class="btn btn-primary" id="btn-rename-confirm">OK</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    /**
     * Stato pagina
     */
    let pairs = [];       // set correnti
    let prevPairs = [];   // set precedenti (solo lettura)
    let editIndex = null; // indice in edit (null = modalità append)
    let viewDate = null;  // data da cui leggo (può essere origin_date)
    let saveDate = null;  // data su cui salvo (lavorazione corrente)
    let activityName = null;
    let exerciseId = null; // id dell'esercizio 

    function ensureVParam(url, id) {
      const u = new URL(url, window.location.origin);
      if (!u.searchParams.has('v')) {
        u.searchParams.set('v', id);
      }
      return u.toString();
    }

    /**
     * Utility querystring
     */
    function getQuery(name) {
      return new URLSearchParams(window.location.search).get(name);
    }

    /**
     * Oggi in formato YYYY-MM-DD
     */
    function todayYMD() {
      const d = new Date();
      const m = String(d.getMonth() + 1).padStart(2, '0');
      const day = String(d.getDate()).padStart(2, '0');
      return d.getFullYear() + '-' + m + '-' + day;
    }

    /**
     * Controllo login
     */
    function ensureLogin(cb) {
      $.getJSON('auth.php?action=me').done(function (res) {
        if (!res.logged) window.location = 'index.html';
        else cb(res);
      });
    }

    /**
     * Messaggio inline: lo teniamo solo per errori/avvisi.
     * (Successo salvataggio -> toast)
     */
    function showMsg(msg, isError) {
      console.log(msg);
      $('#msg-ex')
        .removeClass('d-none alert-success alert-danger')
        .addClass('alert ' + (isError ? 'alert-danger' : 'alert-success'))
        .text(msg);
    }

    /**
     * Toast "Set salvato"
     */
    function showSavedToast() {
      const el = document.getElementById('toastSaved');
      const t = bootstrap.Toast.getOrCreateInstance(el, { delay: 2000 });
      t.show();
    }

    /**
     * Salva su server i set correnti per la data di lavorazione
     */
    function savePairsToServer(cb) {
      $.post('api.php?action=saveExercisePairs', {
        id: exerciseId,
        date: saveDate,
        activity: activityName,
        pairs: JSON.stringify(pairs)
      }).done(function (res) {
        if (res.success) cb(true);
        else cb(false, res.error || 'Errore');
      }).fail(function (xhr) {
        cb(false, xhr.responseText || 'Errore HTTP');
      });
    }

    /**
     * Render tabella set correnti:
     * - verde (table-success) se reps o peso sono > del set precedente alla stessa posizione
     * - giallo (table-warning) se la riga è in edit (anche se sarebbe verde)
     */
    function renderPairs() {
      const tbody = $('#tbl-sets tbody');
      tbody.empty();

      pairs.forEach(function (p, idx) {
        const tr = $('<tr>');

        // 1) Calcolo miglioramento vs storico (stessa posizione)
        let improved = false;
        if (prevPairs && prevPairs[idx]) {
          const prev = prevPairs[idx];
          if ((p.reps > prev.reps) || (p.weight > prev.weight)) improved = true;
        }

        // 2) Classi: l'edit deve "vincere" sul verde
        if (editIndex === idx) {
          tr.addClass('table-warning');
        } else if (improved) {
          tr.addClass('table-success');
        }

        tr.append($('<td>').text(idx + 1));
        tr.append($('<td>').text(p.reps));
        tr.append($('<td>').text(p.weight));

        const btnEdit = $('<button>')
          .addClass('btn btn-sm btn-outline-primary me-1')
          .text('Edit')
          .on('click', function () {
            // Metti in edit e precompila i campi
            editIndex = idx;
            $('#txt-reps').val(p.reps);
            $('#txt-weight').val(p.weight);
            renderPairs();
          });

        const btnDel = $('<button>')
          .addClass('btn btn-sm btn-outline-danger')
          .text('Cancella')
          .on('click', function () {
            if (!confirm('Cancellare questo set?')) return;

            pairs.splice(idx, 1);
            savePairsToServer(function (ok, err) {
              if (!ok) {
                alert(err || 'Errore salvataggio');
              }
              editIndex = null;
              renderPairs();
            });
          });

        tr.append($('<td class="text-end">').append(btnEdit, btnDel));
        tbody.append(tr);
      });
    }

    /**
     * Render tabella set storici:
     * - click sulla riga copia reps/peso nei campi (per inserire rapidamente set simile)
     * - due bottoni invisibili per allineare la colonna "Azioni" con quella dei set correnti
     */
    function renderPrevPairs() {
      const card = $('#card-prev');
      const tbody = $('#tbl-prev-sets tbody');
      tbody.empty();

      if (!prevPairs || !prevPairs.length) {
        card.hide();
        return;
      }

      prevPairs.forEach(function (p, idx) {
        const tr = $('<tr>');

        // Click riga -> copia reps/peso nei textbox
        tr.on('click', function () {
          $('#txt-reps').val(p.reps);
          $('#txt-weight').val(p.weight);
        });

        tr.append($('<td>').text(idx + 1));
        tr.append($('<td>').text(p.reps));
        tr.append($('<td>').text(p.weight));

        const btn1 = $('<button>')
          .addClass('btn btn-sm btn-outline-secondary invisible')
          .attr('tabindex', '-1')
          .text('·');
        const btn2 = $('<button>')
          .addClass('btn btn-sm btn-outline-secondary invisible')
          .attr('tabindex', '-1')
          .text('·');

        tr.append($('<td class="text-end">').append(btn1, btn2));
        tbody.append(tr);
      });

      card.show();
    }

    $(function () {
      /**
       * Se arrivo dal timer con reps/weight in query string, ripopolo i campi.
       * (serve per mantenere i valori identici al ritorno dal timer)
       */
      const repsFromQuery = getQuery('reps');
      const weightFromQuery = getQuery('weight');
      if (repsFromQuery !== null && repsFromQuery !== '') $('#txt-reps').val(repsFromQuery);
      if (weightFromQuery !== null && weightFromQuery !== '') $('#txt-weight').val(weightFromQuery);

      ensureLogin(function () {
        // Lettura esercizio dalla query string
        exerciseId = getQuery('id');
        if (!exerciseId) { showMsg('Parametro id mancante', true); return; }

        // carica tutto by id
        $.getJSON('api.php?action=getExerciseById&id=' + encodeURIComponent(exerciseId))
          .done(function (res) {
            if (!res || res.id === null) { showMsg('Esercizio non trovato', true); return; }

            activityName = res.activity || 'Esercizio';
            $('#title-ex').text(activityName);

            pairs = res.pairs || [];
            prevPairs = res.prev_pairs || [];
            renderPairs();
            renderPrevPairs();
          });

        // Torna a currentworkout (come prima)
        $('#btn-back').on('click', function () {
          const v = Date.now(); // timestamp Unix (ms)
          window.location = 'currentworkout.html?v=' + v;
        });

        // Timer: passa reps/weight correnti in query string
        $('#btn-timer').on('click', function () {
          const v = Date.now();
          const params = new URLSearchParams(window.location.search);
          params.set('reps', $('#txt-reps').val() || '');
          params.set('weight', $('#txt-weight').val() || '');
          const qs = params.toString();
          window.location = 'timer.html' + (qs ? '?' + qs : '');
        });

        // Apertura modale rinomina
        $('#btn-rename-open').on('click', function () {
          $('#txt-rename').val(activityName);
          bootstrap.Modal.getOrCreateInstance(document.getElementById('modalRename')).show();
        });

        // Conferma rinomina
        $('#btn-rename-confirm').on('click', function () {
          const newName = $('#txt-rename').val().trim();
          $.post('api.php?action=renameExercise', {
            id: exerciseId,
            new_name: newName
          }).done(function (res) {
            if (!res.success) alert(res.error || 'Errore');
            else location.reload();
          });
        });

      });

      /**
       * Reps +/- (semplice e veloce per mobile)
       */
      $('#btn-reps-minus').on('click', function () {
        let v = parseInt($('#txt-reps').val(), 10);
        if (isNaN(v)) v = 0;
        $('#txt-reps').val(Math.max(0, v - 1));
      });

      $('#btn-reps-plus').on('click', function () {
        let v = parseInt($('#txt-reps').val(), 10);
        if (isNaN(v)) v = 0;
        $('#txt-reps').val(v + 1);
      });

      /**
       * Peso +/- (click: +/-1; longpress su touch: +/-10 ripetuto)
       */
      function changeWeight(delta) {
        let v = parseFloat($('#txt-weight').val());
        if (isNaN(v)) v = 0;
        v = Math.max(0, v + delta);
        $('#txt-weight').val(v.toFixed(1));
      }

      $('#btn-weight-plus').on('click', () => changeWeight(+1));
      $('#btn-weight-minus').on('click', () => changeWeight(-1));

      const isTouchDevice = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
      if (isTouchDevice) {
        const PRESS_INTERVAL = 500;

        function setupLongPress(selector, deltaLong) {
          let pressTimer = null;
          let repeatTimer = null;
          const $btn = $(selector);

          function startPress() {
            pressTimer = setTimeout(() => {
              changeWeight(deltaLong);
              repeatTimer = setInterval(() => changeWeight(deltaLong), PRESS_INTERVAL);
            }, PRESS_INTERVAL);
          }

          function endPress() {
            clearTimeout(pressTimer);
            clearInterval(repeatTimer);
            pressTimer = null;
            repeatTimer = null;
          }

          $btn.on('touchstart', startPress);
          $btn.on('touchend touchcancel', endPress);
        }

        setupLongPress('#btn-weight-plus', +10);
        setupLongPress('#btn-weight-minus', -10);
      }

      /**
       * Salvataggio set:
       * - se non in edit -> append
       * - se in edit -> update
       * - al successo: toast per pochi secondi + ricalcolo classi (edit torna null, riga torna verde se migliorata)
       */
      $('#btn-save').on('click', function () {
        // Pulisci eventuale errore precedente (non tocco i toast)
        $('#msg-ex').addClass('d-none');

        const reps = parseInt($('#txt-reps').val(), 10);
        const weight = parseFloat($('#txt-weight').val());

        if (isNaN(reps) || reps <= 0 || isNaN(weight) || weight < 0) {
          showMsg('Valori non validi', true);
          return;
        }

        const newSet = { reps: reps, weight: weight };

        if (editIndex === null) {
          pairs.push(newSet);
        } else {
          pairs[editIndex] = newSet;
        }

        // ✅ qui chiami il salvataggio
        savePairsToServer(function (ok, err) {
          if (!ok) {
            showMsg(err || 'Errore salvataggio', true);
            return;
          }

          editIndex = null;
          renderPairs();
          showSavedToast();
        });
      });

    });
  </script>
</body>

</html>