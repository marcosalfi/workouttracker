<!DOCTYPE html>
<html lang="it">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Current Workout</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</head>

<body class="bg-light">
  <div class="container py-3">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h1 class="h5 mb-0">Workout di oggi <span id="lbl-date"></span></h1>
      <button id="btn-back" class="btn btn-outline-secondary btn-sm">Workouts</button>
    </div>

    <!-- Title box -->
    <div class="card mb-3">
      <div class="card-body">
        <label class="form-label">Titolo workout</label>
        <div class="input-group">
          <input type="text" id="txt-title" class="form-control" placeholder="(senza titolo)">
          <button id="btn-save-title" class="btn btn-primary">Salva titolo</button>
        </div>
      </div>
    </div>

    <div class="card mb-3">
      <div class="card-body">
        <div class="mb-2">
          <label class="form-label">Esercizio</label>
          <select id="sel-activity" class="form-select mb-2">
            <option value="">manuale</option>
          </select>
          <input type="text" id="txt-activity" class="form-control" placeholder="Nome esercizio">
        </div>
        <button id="btn-save-ex" class="btn btn-success btn-lg w-100">
          Salva esercizio
        </button>
      </div>
    </div>

    <div class="card">
      <div class="card-body">
        <h2 class="h6 mb-2">Esercizi di oggi</h2>
        <div class="table-responsive">
          <table class="table table-sm table-hover" id="tbl-ex">
            <thead>
              <tr>
                <th>Esercizio</th>
                <th>Set</th>
                <th class="text-end">Azioni</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <div id="msg-ex" class="mt-2 d-none"></div>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div class="toast-container position-fixed bottom-0 end-0 p-3">
    <div id="app-toast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="toast-header">
        <strong class="me-auto">Workout</strong>
        <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
      <div class="toast-body" id="toast-body">Salvato</div>
    </div>
  </div>

  <script>
    let todayStr;

    function ensureVParam(url, id) {
      const u = new URL(url, window.location.origin);
      if (!u.searchParams.has('v')) {
        u.searchParams.set('v', id);
      }
      return u.toString();
    }

    function todayYMD() {
      const d = new Date();
      const m = String(d.getMonth() + 1).padStart(2, '0');
      const day = String(d.getDate()).padStart(2, '0');
      return d.getFullYear() + '-' + m + '-' + day;
    }

    function showToast(msg) {
      $('#toast-body').text(msg);
      const el = document.getElementById('app-toast');
      const t = bootstrap.Toast.getOrCreateInstance(el, { delay: 1500 });
      t.show();
    }

    function getQuery(name) {
      return new URLSearchParams(window.location.search).get(name);
    }

    function ensureLogin(cb) {
      $.getJSON('auth.php?action=me').done(function (res) {
        if (!res.logged) window.location = 'index.html';
        else cb(res);
      });
    }

    function titleKey(dateStr) {
      return 'wo_title_' + dateStr;
    }

    function loadActivitiesSelect() {
      $('#sel-activity').empty().append('<option value="">manuale</option>');

      $.getJSON('api.php?action=listActivities').done(function (res) {
        (res.items || []).forEach(function (row) {
          // row = { id, activity, activity_type }
          $('#sel-activity').append(
            $('<option>')
              .val(row.activity) // oppure row.id se vuoi salvare l'id
              .text(row.activity)
          );
        });
      });
    }

    function loadTodayWorkout() {
      $('#tbl-ex tbody').empty();
      $('#msg-ex').addClass('d-none');
      const v = Date.now(); // timestamp Unix (ms)
      $.getJSON('api.php?action=getWorkout&date=' + encodeURIComponent(todayStr))
        .done(function (res) {
          const items = res.items || [];
          const apiTitle = (res.title || '').trim();

          // se non ci sono record, il titolo "persistente" lo teniamo in localStorage
          const savedTitle = (localStorage.getItem(titleKey(todayStr)) || '').trim();
          const effectiveTitle = apiTitle || savedTitle;

          $('#txt-title').val(effectiveTitle);
          window.currentTitle = effectiveTitle;
          if (!items.length) {
            $('#msg-ex').removeClass('d-none alert-danger')
              .addClass('alert alert-info')
              .text('Workout vuoto: aggiungi un esercizio.');
            return;
          }

          items.forEach(function (it) {
            const tr = $('<tr>');
            const link = $('<a href="#">').text(it.activity).on('click', function (e) {
              e.preventDefault();
              window.location = 'esercizio.html?id='
                + encodeURIComponent(it.id) + '&date=' + encodeURIComponent(todayStr) + '&v=' + v;
            });
            tr.append($('<td>').append(link));

            let summary = '';
            if (it.pairs && it.pairs.length) {
              summary = it.pairs.map(p => p.reps + 'x' + p.weight).join(', ');
            }
            tr.append($('<td>').text(summary));

            const btnDel = $('<button>')
              .addClass('btn btn-sm btn-outline-danger')
              .text('Cancella')
              .on('click', function () {
                if (!confirm('Cancellare tutto l\'esercizio "' + it.activity + '"?')) return;

                $.post('api.php?action=deleteExercise', { id: it.id }).done(function (r) {
                  if (r.success) loadTodayWorkout();
                  else alert(r.error || 'Errore cancellazione');
                });
              });
            tr.append($('<td class="text-end">').append(btnDel));

            $('#tbl-ex tbody').append(tr);
          });

        });
    }

    $(function () {
      ensureLogin(function () {
        todayStr = todayYMD();
        $('#lbl-date').text(todayStr);
        loadTodayWorkout();
        loadActivitiesSelect();
      });


      $('#btn-save-title').on('click', function () {
        const t = ($('#txt-title').val() || '').trim();

        $.post('api.php?action=updateWorkoutTitle', { date: todayStr, title: t })
          .done(function (r) {
            if (r.success) {
              if ((r.updated | 0) > 0) {
                // esiste il giorno (ha record): titolo scritto sul DB
                localStorage.removeItem(titleKey(todayStr));
                showToast('Titolo salvato');
                loadTodayWorkout();
              } else {
                // giorno NON esiste (0 record): niente DB, memorizzo localmente
                localStorage.setItem(titleKey(todayStr), t);
                showToast('Titolo memorizzato (sar√† applicato al primo esercizio)');
              }
            } else {
              alert(r.error || 'Errore salvataggio titolo');
            }
          })
          .fail(function () { alert('Errore salvataggio titolo'); });
      });

      $('#btn-back').on('click', function () {
        const v = Date.now(); // timestamp Unix (ms)
        window.location = 'workoutList.html?v=' + v;
      });

      $('#sel-activity').on('change', function () {
        const v = $(this).val();
        $('#txt-activity').val(v);
      });

      $('#btn-save-ex').on('click', function () {
        const name = $('#txt-activity').val().trim();
        const t = ($('#txt-title').val() || '').trim();
        if (!name) {
          $('#msg-ex').removeClass('d-none alert-success')
            .addClass('alert alert-danger').text('Inserisci un nome esercizio.');
          return;
        }

        $.post('api.php?action=addExercise', {
          date: todayStr,
          title: t,
          activity: name
        }).done(function (r) {
          if (r.success) {
            $('#txt-activity').val('');
            loadTodayWorkout();
          } else {
            alert(r.error || 'Errore salvataggio esercizio');
          }
        });
      });

    });
  </script>
</body>

</html>