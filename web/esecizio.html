<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Esercizio</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
</head>
<body class="bg-light">
<div class="container py-3">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div>
      <h1 class="h5 mb-0" id="title-ex">Esercizio</h1>
      <small id="subtitle-date" class="text-muted"></small>
    </div>
    <div class="d-flex gap-2">
      <button id="btn-rename-open" class="btn btn-outline-primary btn-sm" title="Rinomina esercizio">
        <i class="bi bi-pencil-square"></i>
      </button>
      <button id="btn-timer" class="btn btn-warning btn-sm" title="Timer">
        <i class="bi bi-hourglass-split"></i>
      </button>
      <button id="btn-back" class="btn btn-outline-secondary btn-sm" title="Torna">
        <i class="bi bi-arrow-left"></i>
      </button>
    </div>
  </div>

  <!-- Card inserimento reps/peso -->
  <div class="card mb-3">
    <div class="card-body">
      <div class="row g-2 mb-2 align-items-center">
        <div class="col-12 col-md-6">
          <label class="form-label">Reps</label>
          <div class="input-group">
            <button class="btn btn-outline-secondary" type="button" id="btn-reps-minus">-</button>
            <input type="number" id="txt-reps" class="form-control text-center" min="0" step="1" value="0">
            <button class="btn btn-outline-secondary" type="button" id="btn-reps-plus">+</button>
          </div>
        </div>
        <div class="col-12 col-md-6">
          <label class="form-label">Peso</label>
          <div class="input-group">
            <button class="btn btn-outline-secondary" type="button" id="btn-weight-minus">-</button>
            <input type="number" id="txt-weight" class="form-control text-center" step="0.5" value="0">
            <button class="btn btn-outline-secondary" type="button" id="btn-weight-plus">+</button>
          </div>
        </div>
      </div>
      <button id="btn-save" class="btn btn-success btn-lg w-100 mt-2">Salva set</button>
      <div id="msg-ex" class="mt-2 d-none"></div>
    </div>
  </div>

  <!-- Card set attuali -->
  <div class="card mb-3">
    <div class="card-body">
      <h2 class="h6 mb-2">Set eseguiti (lavorazione corrente)</h2>
      <div class="table-responsive">
        <table class="table table-sm" id="tbl-sets">
          <thead>
            <tr>
              <th>#</th>
              <th>Reps</th>
              <th>Peso</th>
              <th class="text-end">Azioni</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Card set precedenti (solo lettura) -->
  <div class="card" id="card-prev" style="display:none;">
    <div class="card-body">
      <h2 class="h6 mb-2">Set precedenti (originario)</h2>
      <div class="table-responsive">
        <table class="table table-sm" id="tbl-prev-sets">
          <thead>
            <tr>
              <th>#</th>
              <th>Reps</th>
              <th>Peso</th>
              <th class="text-end">Azioni</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Modal rinomina esercizio -->
<div class="modal fade" id="modalRename" tabindex="-1" aria-labelledby="modalRenameLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalRenameLabel">Rinomina esercizio</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Chiudi"></button>
      </div>
      <div class="modal-body">
        <label for="txt-rename" class="form-label">Nuovo nome</label>
        <input type="text" id="txt-rename" class="form-control" placeholder="Nuovo nome esercizio">
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
        <button type="button" class="btn btn-primary" id="btn-rename-confirm">OK</button>
      </div>
    </div>
  </div>
</div>

<script>
let pairs = [];       // set correnti
let prevPairs = [];   // set precedenti (solo lettura)
let editIndex = null;
let viewDate = null;  // data da cui leggo (può essere origin_date)
let saveDate = null;  // data su cui salvo (lavorazione corrente)
let activityName = null;
let originDate = null;

function getQuery(name) {
  return new URLSearchParams(window.location.search).get(name);
}

function todayYMD() {
  const d = new Date();
  const m = String(d.getMonth()+1).padStart(2,'0');
  const day = String(d.getDate()).padStart(2,'0');
  return d.getFullYear() + '-' + m + '-' + day;
}

function ensureLogin(cb) {
  $.getJSON('auth.php?action=me').done(function(res) {
    if (!res.logged) window.location = 'login.html';
    else cb(res);
  });
}

function showMsg(msg, isError) {
  $('#msg-ex')
    .removeClass('d-none alert-success alert-danger')
    .addClass('alert ' + (isError ? 'alert-danger' : 'alert-success'))
    .text(msg);
}

function renderPairs() {
  const tbody = $('#tbl-sets tbody');
  tbody.empty();

  pairs.forEach(function(p, idx) {
    const tr = $('<tr>');

    // confronto con set precedente (se esiste stessa posizione)
    let improved = false;
    if (prevPairs && prevPairs[idx]) {
      const prev = prevPairs[idx];
      if ((p.reps > prev.reps) || (p.weight > prev.weight)) {
        improved = true;
      }
    }

    if (improved) {
      tr.addClass('table-success'); // highlight verde se migliorato
    }
    if (editIndex === idx) {
      tr.addClass('table-primary'); // evidenzia riga in edit
    }

    tr.append($('<td>').text(idx + 1));
    tr.append($('<td>').text(p.reps));
    tr.append($('<td>').text(p.weight));

    const btnEdit = $('<button>')
      .addClass('btn btn-sm btn-outline-primary me-1')
      .text('Edit')
      .on('click', function() {
        editIndex = idx;
        $('#txt-reps').val(p.reps);
        $('#txt-weight').val(p.weight);
        renderPairs();
      });

    const btnDel = $('<button>')
      .addClass('btn btn-sm btn-outline-danger')
      .text('Cancella')
      .on('click', function() {
        if (!confirm('Cancellare questo set?')) return;
        pairs.splice(idx, 1);
        savePairsToServer(function(ok, err) {
          if (!ok) {
            alert(err || 'Errore salvataggio');
          }
          editIndex = null;
          renderPairs();
        });
      });

    tr.append($('<td class="text-end">').append(btnEdit, btnDel));
    tbody.append(tr);
  });
}

function renderPrevPairs() {
  const card = $('#card-prev');
  const tbody = $('#tbl-prev-sets tbody');
  tbody.empty();

  if (!prevPairs || !prevPairs.length) {
    card.hide();
    return;
  }

  prevPairs.forEach(function(p, idx) {
    const tr = $('<tr>');
    tr.append($('<td>').text(idx + 1));
    tr.append($('<td>').text(p.reps));
    tr.append($('<td>').text(p.weight));

    // due tasti invisibili per allineare la colonna azioni
    const btn1 = $('<button>')
      .addClass('btn btn-sm btn-outline-secondary invisible')
      .attr('tabindex', '-1')
      .text('·');
    const btn2 = $('<button>')
      .addClass('btn btn-sm btn-outline-secondary invisible')
      .attr('tabindex', '-1')
      .text('·');

    tr.append($('<td class="text-end">').append(btn1, btn2));
    tbody.append(tr);
  });

  card.show();
}

function savePairsToServer(cb) {
  $.post('api.php?action=saveExercisePairs', {
    date: saveDate,
    activity: activityName,
    pairs: JSON.stringify(pairs)
  }).done(function(res) {
    if (res.success) cb(true);
    else cb(false, res.error || 'Errore');
  }).fail(function(xhr) {
    cb(false, xhr.responseText || 'Errore HTTP');
  });
}

$(function() {
  // se arrivo dal timer con valori in query, li rimetto subito nei campi
  const repsFromQuery = getQuery('reps');
  const weightFromQuery = getQuery('weight');
  if (repsFromQuery !== null && repsFromQuery !== '') {
    $('#txt-reps').val(repsFromQuery);
  }
  if (weightFromQuery !== null && weightFromQuery !== '') {
    $('#txt-weight').val(weightFromQuery);
  }

  ensureLogin(function() {
    const exParam = getQuery('ex');
    if (!exParam) {
      showMsg('Parametro esercizio mancante', true);
      return;
    }
    activityName = decodeURIComponent(exParam).replace(/_/g, ' ');

    const dateParam   = getQuery('date');
    const workoutRef  = getQuery('workoutRef');

    if (workoutRef) {
      const ref        = workoutRef;
      const refDate    = ref.slice(0,4) + '-' + ref.slice(4,6) + '-' + ref.slice(6,8);
      viewDate         = refDate;
      saveDate         = dateParam || todayYMD();
    } else {
      saveDate = dateParam || todayYMD();
      viewDate = saveDate;
    }

    $('#title-ex').text(activityName);

    $.getJSON(
      'api.php?action=getExercise&date=' + encodeURIComponent(viewDate) +
      '&activity=' + encodeURIComponent(activityName)
    ).done(function(res) {
      pairs      = res.pairs || [];
      prevPairs  = res.prev_pairs || [];
      originDate = res.origin_date || viewDate;

      // Niente più testo "Precedente / Lavorazione"
      $('#subtitle-date').text('');

      renderPairs();
      renderPrevPairs();
    });

    $('#btn-back').on('click', function() {
      const qs = window.location.search || '';
      window.location = 'currentworkout.html';
    });

    $('#btn-timer').on('click', function() {
      // porta con sé tutti i parametri della query string corrente
      // arricchiti con i valori attuali di reps e peso
      const params = new URLSearchParams(window.location.search);
      params.set('reps', $('#txt-reps').val() || '');
      params.set('weight', $('#txt-weight').val() || '');
      const qs = params.toString();
      window.location = 'timer.html' + (qs ? '?' + qs : '');
    });

    // Apertura modale rinomina
    $('#btn-rename-open').on('click', function() {
      $('#txt-rename').val(activityName);
      const modal = new bootstrap.Modal(document.getElementById('modalRename'));
      modal.show();
    });

    // Conferma rinomina
    $('#btn-rename-confirm').on('click', function() {
      const newName = $('#txt-rename').val().trim();
      if (!newName) {
        showMsg('Inserisci un nuovo nome per l\'esercizio.', true);
        return;
      }
      if (newName === activityName) {
        showMsg('Il nome è uguale a quello attuale.', true);
        return;
      }

      $.post('api.php?action=renameExercise', {
        date: saveDate,
        old_activity: activityName,
        new_activity: newName
      }).done(function(res) {
        if (!res.success) {
          showMsg(res.error || 'Errore rinomina esercizio', true);
          return;
        }

        activityName = newName;
        $('#title-ex').text(activityName);

        const params = new URLSearchParams(window.location.search);
        params.set('ex', newName.replace(/ /g, '_'));
        const qs = params.toString();
        window.location = 'esecizio.html' + (qs ? '?' + qs : '');
      }).fail(function(xhr) {
        showMsg(xhr.responseText || 'Errore HTTP nella rinomina', true);
      });
    });
  });

  // Pulsanti +/- per reps
  $('#btn-reps-minus').on('click', function() {
    let v = parseInt($('#txt-reps').val(), 10);
    if (isNaN(v)) v = 0;
    v = Math.max(0, v - 1);
    $('#txt-reps').val(v);
  });

  $('#btn-reps-plus').on('click', function() {
    let v = parseInt($('#txt-reps').val(), 10);
    if (isNaN(v)) v = 0;
    v++;
    $('#txt-reps').val(v);
  });

  // Pulsanti +/- per peso
  function changeWeight(delta) {
    let v = parseFloat($('#txt-weight').val());
    if (isNaN(v)) v = 0;
    v = Math.max(0, v + delta);
    $('#txt-weight').val(v.toFixed(1));
  }

  // Click normale (desktop + tap veloce su mobile)
  $('#btn-weight-plus').on('click',  () => changeWeight(+1));
  $('#btn-weight-minus').on('click', () => changeWeight(-1));

  // Long-press solo su device touch
  const isTouchDevice = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
  if (isTouchDevice) {
    const PRESS_INTERVAL = 500; // ms per longpress e ripetizione

    function setupLongPress(selector, deltaLong) {
      let pressTimer = null;
      let repeatTimer = null;
      const $btn = $(selector);
      function startPress() {
        pressTimer = setTimeout(() => {
          changeWeight(deltaLong);
          repeatTimer = setInterval(() => {
            changeWeight(deltaLong);
          }, PRESS_INTERVAL);
        }, PRESS_INTERVAL);
      }
      function endPress() {
        clearTimeout(pressTimer);
        clearInterval(repeatTimer);
        pressTimer = null;
        repeatTimer = null;
      }
      $btn.on('touchstart', startPress);
      $btn.on('touchend touchcancel', endPress);
    }

    setupLongPress('#btn-weight-plus',  +10);
    setupLongPress('#btn-weight-minus', -10);
  }

  // Salvataggio set
  $('#btn-save').on('click', function() {
    const reps   = parseInt($('#txt-reps').val(), 10);
    const weight = parseFloat($('#txt-weight').val());
    if (isNaN(reps) || reps <= 0 || isNaN(weight) || weight < 0) {
      showMsg('Valori non validi', true);
      return;
    }

    const newSet = { reps: reps, weight: weight };
    if (editIndex === null) {
      pairs.push(newSet);
    } else {
      pairs[editIndex] = newSet;
    }

    savePairsToServer(function(ok, err) {
      if (!ok) {
        showMsg(err || 'Errore salvataggio', true);
        return;
      }
      editIndex = null;
      renderPairs();
      showMsg('Set salvato', false);
    });
  });
});
</script>
</body>
</html>
