<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Esercizio</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body class="bg-light">
<div class="container py-3">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div>
      <h1 class="h5 mb-0" id="title-ex">Esercizio</h1>
      <small id="subtitle-date" class="text-muted"></small>
    </div>
    <div class="d-flex gap-2">
      <button id="btn-timer" class="btn btn-warning btn-sm">Timer</button>
      <button id="btn-back" class="btn btn-outline-secondary btn-sm">Torna</button>
    </div>
  </div>

  <!-- Card inserimento reps/peso -->
  <div class="card mb-3">
    <div class="card-body">
      <div class="row g-2 mb-2 align-items-center">
        <div class="col-12 col-md-6">
          <label class="form-label">Reps</label>
          <div class="input-group">
            <button class="btn btn-outline-secondary" type="button" id="btn-reps-minus">-</button>
            <input type="number" id="txt-reps" class="form-control text-center" min="0" step="1" value="0">
            <button class="btn btn-outline-secondary" type="button" id="btn-reps-plus">+</button>
          </div>
        </div>
        <div class="col-12 col-md-6">
          <label class="form-label">Peso</label>
          <div class="input-group">
            <button class="btn btn-outline-secondary" type="button" id="btn-weight-minus">-</button>
            <input type="number" id="txt-weight" class="form-control text-center" step="0.5" value="0">
            <button class="btn btn-outline-secondary" type="button" id="btn-weight-plus">+</button>
          </div>
        </div>
      </div>
      <button id="btn-save" class="btn btn-success btn-lg w-100 mt-2">Salva set</button>
      <div id="msg-ex" class="mt-2 d-none"></div>
    </div>
  </div>

  <!-- Card set attuali -->
  <div class="card mb-3">
    <div class="card-body">
      <h2 class="h6 mb-2">Set eseguiti (lavorazione corrente)</h2>
      <div class="table-responsive">
        <table class="table table-sm" id="tbl-sets">
          <thead>
            <tr><th>#</th><th>Reps</th><th>Peso</th><th class="text-end">Azioni</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Card set precedenti (solo lettura) -->
  <div class="card" id="card-prev" style="display:none;">
    <div class="card-body">
      <h2 class="h6 mb-2">Set precedenti (originario)</h2>
      <div id="prev-info" class="small text-muted mb-2"></div>
      <div class="table-responsive">
        <table class="table table-sm" id="tbl-prev-sets">
          <thead>
            <tr><th>#</th><th>Reps</th><th>Peso</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<script>
let pairs = [];       // set correnti
let prevPairs = [];   // set precedenti (solo lettura)
let editIndex = null;
let viewDate = null;  // data da cui leggo (può essere origin_date)
let saveDate = null;  // data su cui salvo (lavorazione corrente)
let activityName = null;
let originDate = null;

function getQuery(name) {
  return new URLSearchParams(window.location.search).get(name);
}

function todayYMD() {
  const d = new Date();
  const m = String(d.getMonth()+1).padStart(2,'0');
  const day = String(d.getDate()).padStart(2,'0');
  return d.getFullYear() + '-' + m + '-' + day;
}

function ensureLogin(cb) {
  $.getJSON('auth.php?action=me').done(function(res) {
    if (!res.logged) window.location = 'login.html';
    else cb(res);
  });
}

function showMsg(msg, isError) {
  $('#msg-ex')
    .removeClass('d-none alert-success alert-danger')
    .addClass('alert ' + (isError ? 'alert-danger' : 'alert-success'))
    .text(msg);
}

function renderPairs() {
  const tbody = $('#tbl-sets tbody');
  tbody.empty();
  pairs.forEach(function(p, idx) {
    const tr = $('<tr>');
    if (editIndex === idx) {
      tr.addClass('table-success');
    }
    tr.append($('<td>').text(idx + 1));
    tr.append($('<td>').text(p.reps));
    tr.append($('<td>').text(p.weight));

    const btnEdit = $('<button>')
      .addClass('btn btn-sm btn-outline-primary me-1')
      .text('Edit')
      .on('click', function() {
        editIndex = idx;
        $('#txt-reps').val(p.reps);
        $('#txt-weight').val(p.weight);
        renderPairs();
      });

    const btnDel = $('<button>')
      .addClass('btn btn-sm btn-outline-danger')
      .text('Cancella')
      .on('click', function() {
        if (!confirm('Cancellare questo set?')) return;
        pairs.splice(idx, 1);
        savePairsToServer(function(ok, err) {
          if (!ok) {
            alert(err || 'Errore salvataggio');
          }
          editIndex = null;
          renderPairs();
        });
      });

    tr.append($('<td class="text-end">').append(btnEdit, btnDel));
    tbody.append(tr);
  });
}

function renderPrevPairs() {
  const card = $('#card-prev');
  const tbody = $('#tbl-prev-sets tbody');
  tbody.empty();

  if (!prevPairs || !prevPairs.length) {
    card.hide();
    return;
  }

  $('#prev-info').text('Data originaria: ' + originDate);

  prevPairs.forEach(function(p, idx) {
    const tr = $('<tr>');
    tr.append($('<td>').text(idx + 1));
    tr.append($('<td>').text(p.reps));
    tr.append($('<td>').text(p.weight));
    tbody.append(tr);
  });

  card.show();
}

function savePairsToServer(cb) {
  $.post('api.php?action=saveExercisePairs', {
    date: saveDate,
    activity: activityName,
    pairs: JSON.stringify(pairs)
  }).done(function(res) {
    if (res.success) cb(true);
    else cb(false, res.error || 'Errore');
  }).fail(function(xhr) {
    cb(false, xhr.responseText || 'Errore HTTP');
  });
}

$(function() {
  ensureLogin(function() {
    const exParam = getQuery('ex');
    if (!exParam) {
      showMsg('Parametro esercizio mancante', true);
      return;
    }
    activityName = decodeURIComponent(exParam).replace(/_/g, ' ');

    const dateParam   = getQuery('date');
    const workoutRef  = getQuery('workoutRef');

    if (workoutRef) {
      const ref        = workoutRef;
      const refDate    = ref.slice(0,4) + '-' + ref.slice(4,6) + '-' + ref.slice(6,8);
      viewDate         = refDate;
      saveDate         = dateParam || todayYMD();
    } else {
      saveDate = dateParam || todayYMD();
      viewDate = saveDate;
    }

    $('#title-ex').text(activityName);

    $.getJSON(
      'api.php?action=getExercise&date=' + encodeURIComponent(viewDate) +
      '&activity=' + encodeURIComponent(activityName)
    ).done(function(res) {
      pairs      = res.pairs || [];
      prevPairs  = res.prev_pairs || [];
      originDate = res.origin_date || viewDate;

      $('#subtitle-date').text(
        'Precedente: ' + originDate + ' | Lavorazione: ' + saveDate
      );

      renderPairs();
      renderPrevPairs();
    });

    $('#btn-back').on('click', function() {
      const qs = window.location.search || '';
      window.location = 'currentworkout.html';
    });

    $('#btn-timer').on('click', function() {
      // porta con sé tutti i parametri della query string corrente
      const qs = window.location.search || '';
      window.location = 'timer.html' + qs;
    });
  });

  // Pulsanti +/- per reps
  $('#btn-reps-minus').on('click', function() {
    let v = parseInt($('#txt-reps').val(), 10);
    if (isNaN(v)) v = 0;
    v = Math.max(0, v - 1);
    $('#txt-reps').val(v);
  });
  
  $('#btn-reps-plus').on('click', function() {
    let v = parseInt($('#txt-reps').val(), 10);
    if (isNaN(v)) v = 0;
    v++;
    $('#txt-reps').val(v);
  });

  // Pulsanti +/- per peso
    function changeWeight(delta) {
      let v = parseFloat($('#txt-weight').val());
      if (isNaN(v)) v = 0;
      v = Math.max(0, v + delta);
      $('#txt-weight').val(v.toFixed(1));
    }      
      
    // Click normale (desktop + tap veloce su mobile)
    $('#btn-weight-plus').on('click',  () => changeWeight(+1));
    $('#btn-weight-minus').on('click', () => changeWeight(-1));

    // Long-press solo su device touch
    const isTouchDevice = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
    if (isTouchDevice) {
      const PRESS_INTERVAL = 500; // ms per longpress e ripetizione

      function setupLongPress(selector, deltaLong) {
        let pressTimer = null;
        let repeatTimer = null;
        const $btn = $(selector);
        function startPress() {
          // primo +10/-10 dopo PRESS_INTERVAL
          pressTimer = setTimeout(() => {
            changeWeight(deltaLong);
            // poi ogni PRESS_INTERVAL
            repeatTimer = setInterval(() => {
              changeWeight(deltaLong);
            }, PRESS_INTERVAL);
          }, PRESS_INTERVAL);
        }
        function endPress() {
          clearTimeout(pressTimer);
          clearInterval(repeatTimer);
          pressTimer = null;
          repeatTimer = null;
        }
        $btn.on('touchstart', startPress);
        $btn.on('touchend touchcancel', endPress);
      }

      setupLongPress('#btn-weight-plus',  +10);
      setupLongPress('#btn-weight-minus', -10);
    }

  // Salvataggio set
  $('#btn-save').on('click', function() {
    const reps   = parseInt($('#txt-reps').val(), 10);
    const weight = parseFloat($('#txt-weight').val());
    if (isNaN(reps) || reps <= 0 || isNaN(weight) || weight < 0) {
      showMsg('Valori non validi', true);
      return;
    }

    const newSet = { reps: reps, weight: weight };
    if (editIndex === null) {
      pairs.push(newSet);
    } else {
      pairs[editIndex] = newSet;
    }

    savePairsToServer(function(ok, err) {
      if (!ok) {
        showMsg(err || 'Errore salvataggio', true);
        return;
      }
      // NON resetto txt-reps / txt-weight
      editIndex = null;
      renderPairs();
      showMsg('Set salvato', false);
    });
  });
});
</script>
</body>
</html>
