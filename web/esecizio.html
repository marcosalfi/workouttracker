<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Esecizio</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body class="bg-light">
<div class="container py-3">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div>
      <h1 class="h5 mb-0" id="title-ex">Esercizio</h1>
      <small id="subtitle-date" class="text-muted"></small>
    </div>
    <button id="btn-back" class="btn btn-outline-secondary btn-sm">Torna</button>
  </div>

  <div class="card mb-3">
    <div class="card-body">
      <div class="row g-2 mb-2 align-items-center">
        <div class="col-12 col-md-6">
          <label class="form-label">Reps</label>
          <div class="input-group">
            <button class="btn btn-outline-secondary" type="button" id="btn-reps-minus">-</button>
            <input type="number" id="txt-reps" class="form-control text-center" min="0" step="1" value="0">
            <button class="btn btn-outline-secondary" type="button" id="btn-reps-plus">+</button>
          </div>
        </div>
        <div class="col-12 col-md-6">
          <label class="form-label">Peso</label>
          <div class="input-group">
            <button class="btn btn-outline-secondary" type="button" id="btn-weight-minus">-</button>
            <input type="number" id="txt-weight" class="form-control text-center" step="0.5" value="0">
            <button class="btn btn-outline-secondary" type="button" id="btn-weight-plus">+</button>
          </div>
        </div>
      </div>
      <button id="btn-save" class="btn btn-success btn-lg w-100 mt-2">Salva set</button>
      <div id="msg-ex" class="mt-2 d-none"></div>
    </div>
  </div>

  <div class="card">
    <div class="card-body">
      <h2 class="h6 mb-2">Set eseguiti</h2>
      <div class="table-responsive">
        <table class="table table-sm" id="tbl-sets">
          <thead>
            <tr><th>#</th><th>Reps</th><th>Peso</th><th class="text-end">Azioni</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<script>
let pairs = [];
let editIndex = null;
let viewDate = null;
let saveDate = null;
let activityName = null;

function getQuery(name) {
  return new URLSearchParams(window.location.search).get(name);
}

function todayYMD() {
  const d = new Date();
  const m = String(d.getMonth()+1).padStart(2,'0');
  const day = String(d.getDate()).padStart(2,'0');
  return d.getFullYear() + '-' + m + '-' + day;
}

function ensureLogin(cb) {
  $.getJSON('auth.php?action=me').done(function(res) {
    if (!res.logged) window.location = 'login.html';
    else cb(res);
  });
}

function showMsg(msg, isError) {
  $('#msg-ex')
    .removeClass('d-none alert-success alert-danger')
    .addClass('alert ' + (isError ? 'alert-danger' : 'alert-success'))
    .text(msg);
}

function renderPairs() {
  const tbody = $('#tbl-sets tbody');
  tbody.empty();
  pairs.forEach(function(p, idx) {
    const tr = $('<tr>');
    if (editIndex === idx) {
      tr.addClass('table-success');
    }
    tr.append($('<td>').text(idx+1));
    tr.append($('<td>').text(p.reps));
    tr.append($('<td>').text(p.weight));

    const btnEdit = $('<button>')
      .addClass('btn btn-sm btn-outline-primary me-1')
      .text('Edit')
      .on('click', function() {
        editIndex = idx;
        $('#txt-reps').val(p.reps);
        $('#txt-weight').val(p.weight);
        renderPairs();
      });

    const btnDel = $('<button>')
      .addClass('btn btn-sm btn-outline-danger')
      .text('Cancella')
      .on('click', function() {
        if (!confirm('Cancellare questo set?')) return;
        pairs.splice(idx, 1);
        savePairsToServer(function(ok, err) {
          if (!ok) {
            alert(err || 'Errore salvataggio');
          }
          editIndex = null;
          renderPairs();
        });
      });

    tr.append($('<td class="text-end">').append(btnEdit, btnDel));
    tbody.append(tr);
  });
}

function savePairsToServer(cb) {
  $.post('api.php?action=saveExercisePairs', {
    date: saveDate,
    activity: activityName,
    pairs: JSON.stringify(pairs)
  }).done(function(res) {
    if (res.success) cb(true);
    else cb(false, res.error || 'Errore');
  }).fail(function(xhr) {
    cb(false, xhr.responseText || 'Errore HTTP');
  });
}

$(function() {
  ensureLogin(function() {
    const exParam = getQuery('ex');
    if (!exParam) {
      showMsg('Parametro esercizio mancante', true);
      return;
    }
    activityName = decodeURIComponent(exParam).replace(/_/g, ' ');

    const dateParam = getQuery('date');
    const workoutRef = getQuery('workoutRef');

    if (workoutRef) {
      const ref = workoutRef;
      const refDate = ref.slice(0,4) + '-' + ref.slice(4,6) + '-' + ref.slice(6,8);
      viewDate = refDate;
      saveDate = dateParam || todayYMD();
    } else {
      saveDate = dateParam || todayYMD();
      viewDate = saveDate;
    }

    $('#title-ex').text(activityName);
    $('#subtitle-date').text('Visualizzazione: ' + viewDate + ' | Salvataggio su: ' + saveDate);

    $.getJSON('api.php?action=getExercise&date=' + encodeURIComponent(viewDate)
      + '&activity=' + encodeURIComponent(activityName))
      .done(function(res) {
        pairs = res.pairs || [];
        renderPairs();
      });

    $('#btn-back').on('click', function() {
      window.history.back();
    });
  });

  $('#btn-reps-minus').on('click', function() {
    let v = parseInt($('#txt-reps').val(), 10) || 0;
    v = Math.max(0, v-1);
    $('#txt-reps').val(v);
  });
  $('#btn-reps-plus').on('click', function() {
    let v = parseInt($('#txt-reps').val(), 10) || 0;
    v++;
    $('#txt-reps').val(v);
  });
  $('#btn-weight-minus').on('click', function() {
    let v = parseFloat($('#txt-weight').val()) || 0;
    v = Math.max(0, v-0.5);
    $('#txt-weight').val(v.toFixed(1));
  });
  $('#btn-weight-plus').on('click', function() {
    let v = parseFloat($('#txt-weight').val()) || 0;
    v += 0.5;
    $('#txt-weight').val(v.toFixed(1));
  });

  $('#btn-save').on('click', function() {
    const reps = parseInt($('#txt-reps').val(), 10);
    const weight = parseFloat($('#txt-weight').val());
    if (isNaN(reps) || reps <= 0 || isNaN(weight) || weight < 0) {
      showMsg('Valori non validi', true);
      return;
    }

    const newSet = { reps: reps, weight: weight };
    if (editIndex === null) {
      pairs.push(newSet);
    } else {
      pairs[editIndex] = newSet;
    }

    savePairsToServer(function(ok, err) {
      if (!ok) {
        showMsg(err || 'Errore salvataggio', true);
        return;
      }
      $('#txt-reps').val('0');
      $('#txt-weight').val('0');
      editIndex = null;
      renderPairs();
      showMsg('Set salvato', false);
    });
  });
});
</script>
</body>
</html>
